<html>
<head>
<meta charset="utf-8">
<title>ë¡œë˜ ë²ˆí˜¸ ë³´ì •</title>
<script src="./jsQR.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<style type="text/css">
	main {
		width:100%;
		height:100%;
		text-align:center;
	}
	div#frame {
		border:2px solid #005666;
		background-color:#FFFFFF;
		margin-left:10px;
		margin-right:10px;
		padding-left:8px;
		padding-right:8px;
		padding-top:8px;
		padding-bottom:8px;	
	}
	div#outputLayer {
		text-align:left;
	}
	canvas {
		width:100%;
	}
	.modal{
		/* width:50%;
		top:50px;
		position:absolute;
		left:25%; */
		background-color:black;
		text-align:center;
		padding-top:10px;
		display:none;
	}
</style>
</head>

<script type="text/javascript">
	var qrMsg = "http://qr.nlotto.co.kr/?v=0747m011821252728m020710112628m030609172528m040715182428m0709121423281614207942"
	var total_selected_num_list =[]
	// ìŠ¤ìº”
	function startScan() {
		var video = document.createElement("video");		
		var canvasElement = document.getElementById("canvas");
		var canvas = canvasElement.getContext("2d");
		var loadingMessage = document.getElementById("loadingMessage");
		var outputContainer = document.getElementById("output");
		var outputMessage = document.getElementById("outputMessage");
		var outputData = document.getElementById("outputData");

		function drawLine(begin, end, color) {
			canvas.beginPath();
			canvas.moveTo(begin.x, begin.y);
			canvas.lineTo(end.x, end.y);
			canvas.lineWidth = 4;
			canvas.strokeStyle = color;
			canvas.stroke();
		}

	        // ì¹´ë©”ë¼ ì‚¬ìš©ì‹œ
		navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
     		    video.srcObject = stream;
      		    video.setAttribute("playsinline", true);      // iOS ì‚¬ìš©ì‹œ ì „ì²´ í™”ë©´ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒì„ ì „ë‹¬
         		video.play();
      		    requestAnimationFrame(tick);
		});

		function tick() {
			loadingMessage.innerText = "âŒ› ìŠ¤ìº” ê¸°ëŠ¥ì„ í™œì„±í™” ì¤‘ì…ë‹ˆë‹¤."

			if(video.readyState === video.HAVE_ENOUGH_DATA) {
				loadingMessage.hidden = true;
				canvasElement.hidden = false;
				outputContainer.hidden = false;

				// ì½ì–´ë“¤ì´ëŠ” ë¹„ë””ì˜¤ í™”ë©´ì˜ í¬ê¸°
				canvasElement.height = video.videoHeight;
				canvasElement.width = video.videoWidth;
				canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
				
				var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
				var code = jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts : "dontInvert",
    		    });
				
				// QRì½”ë“œ ì¸ì‹ì— ì„±ê³µí•œ ê²½ìš°
				if(code) {
					// ì¸ì‹í•œ QRì½”ë“œì˜ ì˜ì—­ì„ ê°ì‹¸ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§€ëŠ” í…Œë‘ë¦¬ ìƒì„±
					drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF0000");
					drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF0000");
					drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF0000");
					drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF0000");
					
					outputMessage.hidden = true;
					outputData.parentElement.hidden = false;

					// QRì½”ë“œ ë©”ì‹œì§€ ì¶œë ¥
					outputData.innerHTML = code.data;
					qrMsg = code.data;

					// returnì„ ì¨ì„œ í•¨ìˆ˜ë¥¼ ë¹ ì ¸ë‚˜ê°€ë©´ QRì½”ë“œ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œëœë‹¤.
					$('#qrFrame').hide();
					qrParsing();
					return;
				}
				// QRì½”ë“œ ì¸ì‹ì— ì‹¤íŒ¨í•œ ê²½ìš°
				else {
					outputMessage.hidden = false;
					outputData.parentElement.hidden = true;
				}
			}
			requestAnimationFrame(tick);
		}
	}
	
	// ì¹´ë©”ë¼ ì—´ê¸°
	function openCamera() {
		$('#qrFrame').show();
		startScan();
		/* qrParsing() */
	}
	
	//ë°ì´í„° íŒŒì‹±
	function qrParsing(){
		var msg = qrMsg;
		aleat(msg);
		//http://qr.nlotto.co.kr/?v=0747m011821252728m020710112628m030609172528m040715182428m0709121423281614207942
		
		var table_html = ""		
		
		var split_list = msg.split("m");
		for (var i = 1; i < split_list.length; i++) {
			
			
			var split = split_list[i]
			
			var num1 = Number(split.substring(0,2));
			var num2 = Number(split.substring(2,4));
			var num3 = Number(split.substring(4,6));
			var num4 = Number(split.substring(6,8));
			var num5 = Number(split.substring(8,10));
			var num6 = Number(split.substring(10,12));
			
			var selected_num_list = [num1, num2, num3, num4, num5, num6];
			
			total_selected_num_list = total_selected_num_list.concat(selected_num_list);
			total_selected_num_list = [...new Set(total_selected_num_list)]
			total_selected_num_list.sort(function(a, b)  {
				  if(a > b) return 1;
				  if(a === b) return 0;
				  if(a < b) return -1;
				});
			console.log(i, selected_num_list)
			
			
			//ì—¬ê¸°ì„œ ë¶€í„° html ì½”ë“œ
			table_html += '<tr>'
			table_html += '<td>'+ i +'</td>'
			
			for (var j = 0; j < selected_num_list.length; j++) {
				var array_element = selected_num_list[j];
				table_html += '<td>' + array_element + '</td>'
				console.log(i, array_element)
			}
			
			table_html += '</tr>'
			
		}	
		
		console.log('ì „ì²´', total_selected_num_list)
		console.log(table_html)
		$('#dataBody').html('').html(table_html);
		console.log(table_html)
		
	}
	
	
</script>

<body>
<div class="main_page">
	
	<main align="center">
	<h1>í•œì¥ë§Œ ë”?test2</h1>
	<div id='qrFrame' align="center" class='modal'>
		<div></div>
		<div id="frame">
			<div id="loadingMessage">
				ğŸ¥ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì— ì•¡ì„¸ìŠ¤ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br/>ì›¹ìº ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤
			</div>
			<canvas id="canvas"></canvas>
		</div>
	</div>
		
		<br/>
		<input type="button" id="button1" onclick="openCamera();" value="ì¹´ë©”ë¼ ì—´ê¸°" style="width:97%;height:30px"/>
		<br/>
		<div></div>
		<div id="test" width="100%">
			<h4>QR ì½”ë“œ ìŠ¤ìº” ê²°ê³¼</h4>
			<table
			style="width: 80%;left: 10%;position: absolute;text-align: center;margin-top: 4%;">
			<thead>
				<tr>
					<td>ê²Œì„</td>
					<td>num1</td>
					<td>num2</td>
					<td>num3</td>
					<td>num4</td>
					<td>num5</td>
					<td>num6</td>
				</tr>
			</thead>
			<tbody id='dataBody'>
				<tr> <td colspan=7> qrì½”ë“œë¥¼ ìŠ¤ìº”í•´ ì£¼ì„¸ìš” </td></tr>
			</tbody>
		</table>
		</div>
	</main>
</div>
</body>
</html>